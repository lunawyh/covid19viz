// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(t,x){var l;return function(){l&&clearTimeout(l);var f=this,n=arguments;l=setTimeout(function(){t.apply(f,n)},x)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(t,x,l,f){var n=function(f,h){return f-h},w={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var h=String(f),m=h.match(w._reNumber);f={integer:0,fractional:0};m&&m[1]?(f.integer=m[1].split("").length,
f.fractional=m[3]?m[3].split("").length:0):-1<h.toLowerCase().indexOf("e")&&(m=h.split("e"),h=m[0],m=m[1],h&&m&&(h=Number(h),m=Number(m),(f=0<m)||(m=Math.abs(m)),h=w.getDigits(h),f?(h.integer+=m,h.fractional=m>h.fractional?0:h.fractional-m):(h.fractional+=m,h.integer=m>h.integer?1:h.integer-m),f=h));return f},getFixedNumbers:function(f,h){var m;m=Number(f.toFixed(h));m<f?f=m+1/Math.pow(10,h):(f=m,m-=1/Math.pow(10,h));m=Number(m.toFixed(h));f=Number(f.toFixed(h));return[m,f]},getPctChange:function(f,
h,m,l){var A={prev:null,next:null},n;null!=m&&(n=f-m,A.prev=Math.floor(Math.abs(100*(h-m-n)/n)));null!=l&&(n=l-f,A.next=Math.floor(Math.abs(100*(l-h-n)/n)));return A},round:function(f,h){f=f.slice(0);var m,l,A,t,x,z,d,y,r=h&&null!=h.tolerance?h.tolerance:2,u=h&&h.indexes,P=h&&null!=h.strictBounds?h.strictBounds:!1;if(u)u.sort(n);else for(u=[],x=0;x<f.length;x++)u.push(x);for(x=0;x<u.length;x++)if(y=u[x],h=f[y],m=0===y?null:f[y-1],l=y===f.length-1?null:f[y+1],A=w.getDigits(h),A=A.fractional){z=0;for(d=
!1;z<=A&&!d;)t=w.getFixedNumbers(h,z),t=P&&0===x?t[1]:t[0],d=w.hasMinimalChange(h,t,m,l,r),z++;d&&(f[y]=t)}return f},hasMinimalChange:function(f,h,l,n,t){f=w.getPctChange(f,h,l,n);h=null==f.prev||f.prev<=t;l=null==f.next||f.next<=t;return h&&l||f.prev+f.next<=2*t},_reAllZeros:new RegExp("\\"+l.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(f,l){l=l||{places:20,round:-1};(f=x.format(f,l))&&(f=f.replace(w._reSomeZeros,"$1").replace(w._reAllZeros,""));return f}};t("extend-esri")&&(f.numberUtils=
w);return w})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(t,x,l,f,n,w,A,h){function m(d){return d&&x.map(d,function(d){return new A(d)})}function T(d,f,l){var u="";0===f?u=G.lt+" ":f===l&&(u=G.gt+" ");return u+d}var D={},G={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},J={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},z={millisecond:{dateOptions:{formatLength:"long"},
timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},d={formatLength:"short",fullYear:!0},y={formatLength:"short"};t.mixin(D,
{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(r,u){var l=[];null==r||r instanceof Date||(r=new Date(r));u=u||{};u=t.mixin({},u);var m=u.selector?u.selector.toLowerCase():null,C=!m||-1<m.indexOf("time"),m=!m||-1<m.indexOf("date");C&&(u.timeOptions=u.timeOptions||y,u.timeOptions&&(u.timeOptions=t.mixin({},u.timeOptions),u.timeOptions.selector=u.timeOptions.selector||"time",l.push(u.timeOptions)));m&&(u.dateOptions=u.dateOptions||d,u.dateOptions&&
(u.dateOptions=t.mixin({},u.dateOptions),u.dateOptions.selector=u.dateOptions.selector||"date",l.push(u.dateOptions)));l&&l.length?(l=x.map(l,function(d){return f.format(r,d)}),u=1==l.length?l[0]:h["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(d,f){return l[f]})):u=f.format(r);return u},createColorStops:function(d){var f=d.values,r=d.colors,l=d.labelIndexes,m=d.isDate,h=d.dateFormatOptions;d=[];return d=x.map(f,function(d,u){var C=null;if(!l||-1<x.indexOf(l,u)){var n;(n=
m?D.formatDate(d,h):w.format(d))&&(C=T(n,u,f.length-1))}return{value:d,color:r[u],label:C}})},updateColorStops:function(d){var f=d.stops,r=d.changes,l=d.isDate,m=d.dateFormatOptions,h=[],n,t=x.map(f,function(d){return d.value});x.forEach(r,function(d){h.push(d.index);t[d.index]=d.value});n=w.round(t,{indexes:h});x.forEach(f,function(d,u){d.value=t[u];if(null!=d.label){var r,h=null;(r=l?D.formatDate(n[u],m):w.format(n[u]))&&(h=T(r,u,f.length-1));d.label=h}})},createClassBreakLabel:function(d){var f=
d.minValue,l=d.maxValue,r=d.isFirstBreak?"":G.gt+" ";d="percent-of-total"===d.normalizationType?G.pct:"";f=null==f?"":w.format(f);l=null==l?"":w.format(l);return r+f+d+" \u2013 "+l+d},setLabelsForClassBreaks:function(d){var f=d.classBreaks,l=d.classificationMethod,r=d.normalizationType,m=[];f&&f.length&&("standard-deviation"===l?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):d.round?(m.push(f[0].minValue),x.forEach(f,function(d){m.push(d.maxValue)}),
m=w.round(m),x.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:0===f?m[0]:m[f],maxValue:m[f+1],isFirstBreak:0===f,normalizationType:r})})):x.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===f,normalizationType:r})}))},updateClassBreak:function(d){var f=d.classBreaks,l=d.normalizationType,m=d.change,r=m.index,m=m.value,h=-1,n=-1,t=f.length;"standard-deviation"===d.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):
(0===r?h=r:r===t?n=r-1:(n=r-1,h=r),-1<h&&h<t&&(d=f[h],d.minValue=m,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===h,normalizationType:l})),-1<n&&n<t&&(d=f[n],d.maxValue=m,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===n,normalizationType:l})))},calculateDateFormatInterval:function(d){var f,l,m=d.length,h,r,n,t,y,z,A=Infinity,w;d=x.map(d,function(d){return new Date(d)});for(f=0;f<m-1;f++){h=d[f];n=[];y=Infinity;z=
"";for(l=f+1;l<m;l++)r=d[l],r=h.getFullYear()!==r.getFullYear()&&"year"||h.getMonth()!==r.getMonth()&&"month"||h.getDate()!==r.getDate()&&"day"||h.getHours()!==r.getHours()&&"hour"||h.getMinutes()!==r.getMinutes()&&"minute"||h.getSeconds()!==r.getSeconds()&&"second"||"millisecond",t=J[r],t<y&&(y=t,z=r),n.push(r);y<A&&(A=y,w=z)}return w},createUniqueValueLabel:function(d){var f=d.value,l=d.fieldInfo,m=d.domain;d=d.dateFormatInterval;var h=String(f);(m=m&&m.codedValues?m.getName(f):null)?h=m:"number"===
typeof f&&(h=l&&"esriFieldTypeDate"===l.type?D.formatDate(f,d&&z[d]):w.format(f));return h},cloneColorInfo:function(d){var f;d&&(f=t.mixin({},d),f.colors=m(f.colors),f.stops=f.stops&&x.map(f.stops,function(d){d=t.mixin({},d);d.color&&(d.color=new A(d.color));return d}),f.legendOptions&&(f.legendOptions=t.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(d){var f;if(d){f=t.mixin({},d);if(d=f.opacityValues)f.opacityValues=d.slice(0);if(d=f.stops)f.stops=x.map(d,function(d){return t.mixin({},
d)});if(d=f.legendOptions)f.legendOptions=t.mixin({},d)}return f},cloneSizeInfo:function(d){var f;d&&(f=t.mixin({},d),f.stops&&(f.stops=x.map(f.stops,function(d){return t.mixin({},d)})),(d=f.minSize)&&"object"===typeof d&&(f.minSize=D.cloneSizeInfo(d)),(d=f.maxSize)&&"object"===typeof d&&(f.maxSize=D.cloneSizeInfo(d)),d=f.legendOptions)&&(f.legendOptions=t.mixin({},d),d=d.customValues)&&(f.legendOptions.customValues=d.slice(0));return f},getClassCodesForRelationship:function(){return t.clone({2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return t.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});l("extend-esri")&&t.setObject("renderer.utils",D,n);return D})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(t,
x,l,f,n,w,A,h,m,T,D,G,J,z,d,y,r,u,P,K,C,ba,W,U,L,E,M,ja,ka,la,ma,na,oa,X,pa,ca,Q,V,Y,da,R,ea,fa,Z){var ga=M.getClassValuesForRelationship(),ha={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},aa={HH:315,HL:45,LL:135,LH:225},ia=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,F=x([fa,u],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new A([64,
64,64]),defaultText:"Aa",sizeRampLightColor:new A([255,255,255]),sizeRampDarkColor:new A([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(a,b){l.mixin(this,Z.widgets.legend);this._i18n=Z.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?
!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===F.ALIGN_RIGHT?F.ALIGN_RIGHT:F.ALIGN_LEFT,this.arrangement===F.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=h(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],t.locale&&-1!==t.locale.indexOf(c)&&(-1!==t.locale.indexOf("-")?-1!==t.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>m("ie")&&(this._repaintItems=l.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||f.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=
[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=
this.domNode.children.length-1;0<=a;a--)d.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):
this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var e;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&
(e=c.getLayers(),f.forEach(e,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),f.forEach(e,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1==f.indexOf(a,c)&&-1==f.indexOf(b,c)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&
(a._params&&a._params.drawMode||a.isFeatureReductionActive&&a.isFeatureReductionActive())},_activate:function(){this._deactivate();if(this.autoUpdate){this._mapConnects=[];this._layerConnects={};var a=this._mapConnects;this._respectCurrentMapScale&&a.push(n.connect(this.map,"onZoomEnd",this,"_refreshLayers"));this.useAllMapLayers&&(a.push(n.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),a.push(n.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),a.push(n.connect(this.map,"onLayersReordered",
this,"_updateAllMapLayers")));f.forEach(this.layers,function(a){var b=[n.connect(a,"onFeatureReductionRendererChange",this,"_refreshLayers"),n.connect(a,"onFeatureReductionChange",this,"_refreshLayers"),n.connect(a,"onVisibilityChange",this,"_refreshLayers"),n.connect(a,"onOpacityChange",this,"_refreshLayers"),n.connect(a,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&b.push(n.connect(a,"_onDynamicLayersChange",l.hitch(this,
"_updateDynamicLayers",a)));if("esri.layers.ArcGISImageServiceLayer"===a.declaredClass||"esri.layers.RasterXLayer"===a.declaredClass)b.push(n.connect(a,"onRenderingChange",l.partial(this._updateImageServiceLayers,this,a))),b.push(n.connect(a,"onRendererChange",l.partial(this._updateImageServiceLayers,this,a)));("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||a.setWebGLEnabled)&&b.push(n.connect(a,"onRendererChange",l.hitch(this,"_refreshLayers")));this._layerConnects[a.id]=b},this)}},
_deactivate:function(){f.forEach(this._mapConnects,function(a){n.disconnect(a)});f.forEach(this.layers,function(a){var b=this._layerConnects;b&&f.forEach(b[a.id],function(a){n.disconnect(a)})},this);this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;y.set(this.domNode,"position","relative");d.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];f.forEach(this.layers,function(g){if("esri.layers.KMLLayer"==
g.declaredClass||"esri.layers.GeoRSSLayer"==g.declaredClass){var e;g.loaded?("esri.layers.KMLLayer"==g.declaredClass?e=g.getLayers():"esri.layers.GeoRSSLayer"==g.declaredClass&&(e=g.getFeatureLayers(),this.hideLayersInLegend[g.id]&&(e=f.filter(e,function(a){return-1==f.indexOf(this.hideLayersInLegend[g.id],a.id)},this))),f.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&g._titleForLegend&&(a._titleForLegend=g._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=
this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_areas),c.push(a))},this)):n.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===g.declaredClass)if(!g.loaded)n.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&g.visible)&&0<g.layerInfos.length&&f.some(g.layerInfos,
function(a){return a.legendURL})){var v=!1;f.forEach(g.layerInfos,function(b){if(b.legendURL&&-1<f.indexOf(g.visibleLayers,b.name)){v||(d.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(g._titleForLegend||g.name||g.id)+"\x3c/span\x3e"},this.domNode),v=!0);var c;b=b.legendURL;if(g.customParameters||g.customLayerParameters){var e=l.clone(g.customParameters||{});l.mixin(e,g.customLayerParameters||{});for(c in e)b+=(-1===b.indexOf("?")?"?":"\x26")+c+"\x3d"+e[c]}d.create("div",
{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==g.declaredClass||g.renderer?c.push(g):(e=d.create("div",{id:this.id+"_"+g.id,"class":"esriLegendService"}),d.create("span",{innerHTML:this._getServiceTitle(g),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},e))))),d.place(e,this.id,"first"),e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e),e=d.create("tbody",{},e),"esriGeometryComplex"===g.geometryType?(this._buildRow_Renderer(g,g._pointSymbol,null,this.NLS_points,null,e),this._buildRow_Renderer(g,g._lineSymbol,null,this.NLS_lines,null,e),this._buildRow_Renderer(g,g._polygonSymbol,null,this.NLS_areas,null,e)):"esriGeometryPoint"===g.geometryType?this._buildRow_Renderer(g,g._pointSymbol,null,"",null,e):"esriGeometryPolyline"===g.geometryType?this._buildRow_Renderer(g,g._lineSymbol,null,"",null,e):"esriGeometryPolygon"===g.geometryType&&
this._buildRow_Renderer(g,g._polygonSymbol,null,"",null,e),b=!0)},this);var e=[];f.forEach(c,function(a){if(!a.loaded)var b=n.connect(a,"onLoad",this,function(a){n.disconnect(b);b=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass||"esri.layers.RasterXLayer"==a.declaredClass)){var c=d.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});d.create("span",
{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},c)))));d.place(c,this.id,"first");a.legendResponse||a.renderer&&"esri.renderer.StretchRenderer"!==a.renderer.declaredClass||a.renderer&&"esri.renderer.StretchRenderer"===a.renderer.declaredClass&&1===a.bandCount?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(l.hitch(this,function(a){this._createLegendForLayer(a)}),
l.hitch(this,function(a){e.push(this._legendRequest(a))})):"esri.layers.RasterXLayer"===a.declaredClass&&-1<a.capabilities.toLowerCase().indexOf("tilesonly")?this._createLegendForTileOnlyService(a):e.push(this._legendRequest(a))}},this);0!==e.length||a||b?(new G(e)).addCallback(l.hitch(this,function(c){a||b?z.byId(this.id+"_msg").innerHTML="":z.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(z.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForTileOnlyService:function(a){function b(b,
e){var d=["red","green","blue"],p=[[255,0,0],[0,255,0],[0,0,255]];(e&&e.length>=f?c(e):c()).forEach(function(c,e){var f=new Q(Q.STYLE_SQUARE,20,new V(V.STYLE_SOLID,new A([0,0,0]),1),new A(p[e]));b._buildRow_Renderer(a,f,null,d[e]+": "+c,null,g)},b)}function c(b){var c=(a.bandIds&&a.bandIds.length?a.bandIds:[0,1,2]).map(function(a){return b&&b[a]&&b[a].BandName||"Band_"+(a+1)});3>c.length?c.push(c[1]):3<c.length&&c.splice(3);return c}var e=d.create("div",{id:this.id+"_"+a.id+"_clientLegend","class":"esriLegendServiceLabel"},
z.byId(this.id+"_"+a.id));d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));var e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),g=d.create("tbody",{},e),f=a.bandCount;if(1<f)a.getKeyProperties().then(l.hitch(this,function(a){b(this,a.BandProperties)}),l.hitch(this,function(a){b(this)})),y.set(z.byId(this.id+"_"+a.id),"display","block"),y.set(z.byId(this.id+"_msg"),"display",
"none");else{var e={colorRamp:{type:"algorithmic",fromColor:[0,0,0],toColor:[255,255,255]}},v=a.renderer,B,q;v&&v.statistics&&v.statistics.length?(B=null!=v.statistics[0].min?v.statistics[0].min:v.statistics[0][0],q=null!=v.statistics[0].max?v.statistics[0].max:v.statistics[0][1]):(B=a.serviceInfo.minValues.length?a.serviceInfo.minValues[0]:0,q=a.serviceInfo.maxValues.length?a.serviceInfo.maxValues[0]:255);this._createStretchLegend(g,v||e,B,q)}},_createLegendForLayer:function(a){if(a.legendResponse||
a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)f.forEach(c,function(c,g){this.hideLayersInLegend[a.id]&&-1!==f.indexOf(this.hideLayersInLegend[a.id],c.id)||(c=this._buildLegendItems(a,c,g),b=b||c)},this);else if("esri.layers.ArcGISImageServiceLayer"==a.declaredClass||"esri.layers.RasterXLayer"==a.declaredClass)b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},
0)}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(y.set(z.byId(this.id+"_"+a.id),"display","block"),y.set(z.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);n.connect(a,"onLoad",l.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=
b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=l.hitch(this,"_processLegendResponse"),g={f:"json"};a._params.dynamicLayers&&(g.dynamicLayers=J.stringify(this._createDynamicLayers(a)),"[{}]"===g.dynamicLayers&&(g.dynamicLayers="[]"));a._params.bandIds&&(g.bandIds=a._params.bandIds);a._params.renderingRule?g.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,
function(a){a&&a.name&&"none"===a.name.toLowerCase()&&(g.renderingRule=J.stringify({rasterFunction:a.name}))});return U({url:b,content:g,callbackParamName:"callback",load:function(b,c){e(a,b,c)},error:W.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!m("ie")||8<m("ie"))b+="\x26returnbytes\x3dtrue";var c=l.hitch(this,"_processLegendResponse");
return U({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,g){c(a,b,g)},error:W.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,z.byId(this.id+"_"+a.id)&&d.empty(z.byId(this.id+"_"+a.id)),d.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},z.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):
console.log("Legend could not get generated for "+a.url+": "+w.toJson(b))},_buildLegendItems:function(a,b,c){var e=!1,g=z.byId(this.id+"_"+a.id),p=b.parentLayerId;if(b.subLayerIds)a=d.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==p?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==p?g:z.byId(this.id+"_"+a.id+"_"+p+"_group")),d.create("td",{innerHTML:C.encode(b.name),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},
a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===f.indexOf(c,b.id))return e}else if(-1===f.indexOf(a.visibleLayers,b.id))return e;g=d.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<p?this._legendAlign:""},-1==p?g:z.byId(this.id+"_"+a.id+"_"+p+"_group"));d.create("td",{innerHTML:C.encode(b.name)||
"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},g))));c=a.dynamicLayerInfos||a.layerInfos;p=!1;c&&c.length&&(p=f.some(c,function(a){return!!a.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,g);else if(a.renderer||p)e=e||this._buildLegendItems_Renderer(a,b,g)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],g;for(g=0;g<a.length;g++)if(a[g].subLayerIds){if(-1===
f.indexOf(b,a[g].id)||-1<f.indexOf(e,a[g].id))e=e.concat(a[g].subLayerIds)}else-1<f.indexOf(b,a[g].id)&&-1===f.indexOf(e,a[g].id)&&c.push(a[g].id);return c},_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,g=this.map.getScale(),p=!1,v=function(a,b){var c,e;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(e=0;e<b.dynamicLayerInfos[e].length;e++){if(b.dynamicLayerInfos[e].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||
this._respectCurrentMapScale&&this._isLayerInScale(a,b,g)){var B=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var q=this._getEffectiveScale(a,b);if(q.minScale&&q.minScale<g||q.maxScale&&q.maxScale>g)B=!1}if(B){var g=v(a.legendResponse.layers,b),k=g.legendType,l=g.layerType,m=g.legend;if(m){"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&"esri.layers.RasterXLayer"===a.declaredClass||
this._sanitizeLegendResponse(a,g,b);c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var h=d.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);var n=[];f.forEach(m,function(c){if(!(10.1<=a.version&&!c.values&&1<m.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==c.label&&(c.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||"Raster Layer"===l)){var e=c.label;if(c.url&&0===c.url.indexOf("http")||
c.imageData&&0<c.imageData.length)p=!0,e&&-1!==f.indexOf(n,e)||(n.push(e),this._buildRow_Tools(c,h,a,b.id,k))}},this)}}}p&&(y.set(z.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(y.set(z.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return p},_getLayerInfos:function(a){var b=new D,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(f.some(c,function(a){return!!a.drawingInfo}))b.resolve(a);else{var e=a.url,g=e.indexOf("?"),e=-1==g?e+"/layers":
e.substring(0,g)+"/layers"+e.substring(g,e.length);U({url:e,content:{f:"json"},callbackParamName:"callback",load:function(e,g){e.layers?(f.forEach(c,function(a){var b=f.filter(e.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&b[0]&&b[0].drawingInfo&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=
l.getObject("layerDefinition.drawingInfo.renderer",!1,c);var g,d;a||(a=l.getObject("drawingInfo.renderer",!1,c));f.some(e,function(a){if(a.values)return!0})&&f.some(e,function(a,b){a.values||(d=b,g=a);return!!g});a?"uniqueValue"===a.type?g&&(e.splice(d,1),e.push(g)):"classBreaks"===a.type&&(g&&e.splice(d,1),e.reverse(),g&&e.push(g)):g&&(e.splice(d,1),e.push(g));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,g){var f=d.create("tr",{},b),v;this.alignRight?(b=d.create("td",{align:this._isRightToLeft?
"left":"right"},f),v=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(v=d.create("td",{width:35,align:"center"},f),b=d.create("td",{},f));f=a.url;(!m("ie")||9<=m("ie")||9>m("ie")&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass))&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=d.create("img",{src:f,
border:0,style:"opacity:"+c.opacity},v);a=d.create("td",{innerHTML:C.encode(a.label),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%",dir:"ltr"},b))));g&&"Stretched"===g&&10.3<=c.version&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>m("ie")&&(e.style.filter="alpha(opacity\x3d"+
100*c.opacity+")")},_getVariable:function(a,b,c){var e;a&&(e=(a=a.getVisualVariablesForType(b,c))&&a[0]);return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?f.filter(a,function(a){return!(!a||a.field!==b||a.normalizationField!=c)}):a},_getFieldAlias:function(a,b,c){var e=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null),e=e&&e.getFieldInfo&&
e.getFieldInfo(a);a=l.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,e){var g;a&&!l.isFunction(a)&&(g=(c=(a=this.getField(c,a,e))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null);return g},_getRampTitle:function(a,b,c){var e,g=a.field,d=a.normalizationField,f=!1,B=!1,q=!1,g=l.isFunction(g)?null:g,d=l.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)e=a.legendOptions.title;
else if(a.valueExpressionTitle)e=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var k=b.renderer.authoringInfo.visualVariables;for(a=0;a<k.length;a++){var m=k[a];if("colorInfo"===m.type&&"ratio"===m.style){f=!0;break}else if("colorInfo"===m.type&&"percent"===m.style){B=!0;break}else if("colorInfo"===m.type&&"percentTotal"===m.style){q=!0;break}}}(f=q&&"showRatioPercentTotal"||B&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||
g&&"showField"||null)&&(e=L.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===f?"${field}":this._i18n[f]))}return e},_getRendererTitle:function(a,b,c){var e;if(a){var g,d,f;"esri.renderer.ClassBreaksRenderer"===a.declaredClass&&(g=a.attributeField,d=a.normalizationField,f="percent-of-total"===a.normalizationType);g=l.isFunction(g)?null:g;d=l.isFunction(d)?null:d;a.legendOptions&&a.legendOptions.title?e=a.legendOptions.title:a.valueExpressionTitle?
e=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||g&&"showField"||null)&&(e=L.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return e},_buildLegendItems_Renderer:function(a,b,c){var e=b.parentLayerId,g=this.map,p=g.getScale(),v,B=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,p)){var q,k,m,h,n,t,u;k="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:
b&&b.drawingInfo?ea.fromJson(l.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===k.declaredClass&&(k=(g="zoom"===k.rangeType?k.getRendererInfoByZoom(g.getZoom()):k.getRendererInfoByScale(p))&&g.renderer,!k))return!1;g=k&&k.authoringInfo&&"relationship"===k.authoringInfo.type;if("esri.renderer.StretchRenderer"!==k.declaredClass&&"esri.renderer.ShadedReliefRenderer"!==k.declaredClass){var r=
this._getVariables(k),x=f.filter(r,function(a){return!!a}).length,w=r[0],H=r[1],r=r[2],D,S,E,F,N;w&&(m=this._getMedianColor(k,w),w.field&&(n=l.isFunction(w.field)?null:this.getField(a,w.field,b)),D=!(w.legendOptions&&!1===w.legendOptions.showLegend));H&&(H.field&&(u=l.isFunction(H.field)?null:this.getField(a,H.field,b)),S=!(H.legendOptions&&!1===H.legendOptions.showLegend));r&&(r.field&&(t=l.isFunction(r.field)?null:this.getField(a,r.field,b)),E=!(r.legendOptions&&!1===r.legendOptions.showLegend))}if("esri.renderer.HeatmapRenderer"===
k.declaredClass)v=B=!0,this._showHeatRamp(a,b,k,c);else if("esri.renderer.DotDensityRenderer"===k.declaredClass)v=B=!0,this._showDotDensityLegend(a,b,k,c);else if("esri.renderer.TemporalRenderer"===k.declaredClass)v=B=!0,p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(p,a,b),k.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===k.latestObservationRenderer.declaredClass&&
this._buildRow_Renderer(a,k.latestObservationRenderer.symbol,m,C.encode(k.latestObservationRenderer.label)||this.NLS_currentObservations,null,q),k.observationRenderer&&"esri.renderer.SimpleRenderer"===k.observationRenderer.declaredClass&&this._buildRow_Renderer(a,k.observationRenderer.symbol,m,C.encode(k.observationRenderer.label)||this.NLS_previousObservations,null,q);else if("esri.renderer.UniqueValueRenderer"===k.declaredClass){if(k.infos&&0<k.infos.length){v=B=!0;if(k.legendOptions&&k.legendOptions.title||
k.valueExpressionTitle)p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),x=k.legendOptions&&k.legendOptions.title?k.legendOptions.title:k.valueExpressionTitle,this._buildRow_Renderer(a,null,m,C.encode(x),null,q);p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);q=d.create("tbody",{},p);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(p,a,b);k.attributeField&&r&&this._addSubHeader(q,this._getFieldAlias(k.attributeField,
a,b));if(g){var I=k.authoringInfo;N=I.focus;var x=I.numClasses,G=I.field1.field,p=I.field2.field;if(x&&G&&p){var O=I.field1.normalizationField,I=I.field2.normalizationField,K=O&&this._i18n.showNormField||G&&"${field}",P=I&&this._i18n.showNormField||p&&"${field}",G=L.substitute({field:this._getFieldAlias(G,a,b),normField:O&&this._getFieldAlias(O,a,b)},K),p=L.substitute({field:this._getFieldAlias(p,a,b),normField:I&&this._getFieldAlias(I,a,b)},P),O={shapeDescriptor:ha,rotation:this._getRotationAngleForFocus(N)||
0};this._buildRow_Renderer(a,null,null,C.encode(G),null,q,null,O);O.rotation+=90;this._buildRow_Renderer(a,null,null,C.encode(p),null,q,null,O);this._drawRelationshipLegend(c,{numClasses:x,focus:N,uvInfos:k.infos})}}else{var M=[];f.forEach(k.infos,function(c){var e=null;this._isLayerEditable(a)&&a.types&&(e=this._getTemplateFromTypes(a.types,c.value));var g=c.label;null==g&&(g=this._getDomainName(k.attributeField,c.value,a,b)||c.value);-1===f.indexOf(M,g)&&(M.push(g),this._buildRow_Renderer(a,c.symbol,
m,C.encode(g),e,q))},this)}}N=!g&&this._displayDefaultSymbol(a,k,c)}else if("esri.renderer.ClassBreaksRenderer"===k.declaredClass){if(k.infos&&0<k.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)v=B=!0,F=this._isUnclassedRenderer(k),w||1!==k.infos.length||(h=(h=k.infos[0])&&h.symbol),F||(p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),x=this._getRendererTitle(k,a,b),this._buildRow_Renderer(a,null,m,C.encode(x),
null,q)),p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(p,a,b),F&&r&&E||(g=k.infos.slice(0).reverse(),f.forEach(g,function(b){var c=b.label;null!=c||F||(c=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,m,C.encode(c),null,q)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==a.declaredClass||a.renderer.style!==X.STYLE_SCALAR&&a.renderer.style!==X.STYLE_SINGLE_ARROW||
(this._buildRow_Renderer(a,k.defaultSymbol,null,"",null,q),a._hideDefaultSymbol=!0);F||(N=this._displayDefaultSymbol(a,k,c))}else if("esri.renderer.StretchRenderer"===k.declaredClass){v=B=!0;p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c);q=d.create("tbody",{},p);var J=this;a.renderingRule?a.getRenderingRuleServiceInfo(a.renderingRule).then(function(b){var c=b&&b.minValues&&0<b.minValues.length&&b.maxValues&&0<b.maxValues.length;b&&1<b.bandCount||!c?J._legendRequest(a).then(function(b){J._processLegendResponse(a,
b)}):J._createStretchLegend(q,k,b.minValues[0],b.maxValues[0])}):(g=a.serviceInfo,"esri.layers.RasterXLayer"===a.declaredClass&&(g=a.raster.serviceInfo),this._createStretchLegend(q,k,g.minValues[0],g.maxValues[0]))}else"esri.renderer.ShadedReliefRenderer"===k.declaredClass?(v=B=!0,p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c),q=d.create("tbody",{},p),this._createStretchLegend(q,k,0,255)):"esri.renderer.SimpleRenderer"===k.declaredClass?(v=B=!0,p=d.create("table",
{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(p,a,b),h=null,this._isLayerEditable(a)&&a.templates&&0<a.templates.length&&(h=a.templates[0]),g=1<x?null:n&&D||u&&S||t&&E,this._buildRow_Renderer(a,k.symbol,m,C.encode(g?this._getRampTitle(1<x?null:w||H||r,a,b):k.label),h,q),h=w?null:k.symbol,g&&(n=u=t=null)):"esri.renderer.ColormapRenderer"===k.declaredClass&&(k.colormapInfos&&k.colormapInfos.length&&
(v=B=!0),p=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),q=d.create("tbody",{},p),k.colormapInfos.forEach(function(b){var c=new Y(Y.STYLE_SOLID,null,new A(b.color));this._buildRow_Renderer(a,c,null,b.label,null,q)},this),a._hideDefaultSymbol=!0);v&&(w&&D&&(w.field||w.valueExpression)&&this._showGradientRamp(a,b,k,null,c,w,n,null,r&&E?!0:!1),r&&E&&(r.field||r.valueExpression&&!ia.test(r.valueExpression))&&(v=w&&D||"esri.renderer.UniqueValueRenderer"===k.declaredClass?
!1:!0,this._showSizeLegend(a,b,k,r,m,c,t,null,v)),H&&S&&(H.field||H.valueExpression)&&this._showGradientRamp(a,b,k,h&&!h.url&&h.color?h.color:this.transparencyRampColor,c,H,u,null,!1));N||F&&!D&&!E&&!S||(N=this._displayDefaultSymbol(a,k,c));B=B||N}B&&(y.set(z.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(y.set(z.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,e)));return B},_createStretchLegend:function(a,b,c,e){var g=d.create("tr",{},a),f;f=d.create("td",
{rowspan:2,"class":"esriStretchLegend"},g);b=d.toDom(this._addColorRamp(b.colorRamp));d.place(b,f);d.create("td",{},g).innerHTML=this._i18n.high+": "+Math.round(e*Math.pow(10,3))/Math.pow(10,3);a=d.create("tr",{},a);d.create("td",{},a).innerHTML=this._i18n.low+": "+Math.round(c*Math.pow(10,3))/Math.pow(10,3)},_addColorRamp:function(a){a||(a={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var b=this._generateColorRampDivs(a);a.label="\x3cdiv class\x3d'esriStretchLegendGradientLabel'\x3e"+
b+"\x3c/div\x3e";return a.label},_generateColorRampDivs:function(a){if(a){var b,c="";if("multipart"===a.type){b=100/a.colorRamps.length;var e=a.colorRamps;Object.keys(e).reverse().forEach(function(a){c+=this._generateSingleGradientDiv(e[a].fromColor,e[a].toColor,b)},this)}else c=this._generateSingleGradientDiv(a.fromColor,a.toColor,100);return c}},_generateSingleGradientDiv:function(a,b,c){if(a&&b){var e,g="";a=a.toRgb?a.toRgb():a;b=b.toRgb?b.toRgb():b;e="(0deg, rgb("+a.slice(0,3).join()+"), rgb("+
b.slice(0,3).join()+"));";f.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],function(a){g+="background: "+a+e});return"\x3cdiv class\x3d'esriStretchLegendSingleGradient' style\x3d'height:"+c+"%;"+g+"'\x3e\x3c/div\x3e"}},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&a.isEditable()},_isUnclassedRenderer:function(a,b){var c;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){c=a.attributeField;
var e=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,e).length}return c},_displayDefaultSymbol:function(a,b,c){var e;!a._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=d.create("tbody",{},c),this._buildRow_Renderer(a,b.defaultSymbol,null,C.encode(b.defaultLabel)||"others",null,c));return e},_showGradientRamp:function(a,b,c,e,g,f,v,m,q){q=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(q?"":" esriLegendSubFragment")},g);g=d.create("tbody",{},q);(a._hoverLabel||a._hoverLabels||m)&&this._createHoverAction(q,a,b,m);(v||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(g,this._getRampTitle(f,a,b));v=f.field;var k;v&&(k=l.isFunction(v)?null:this.getField(a,v,b));if(f=(b=this._getRampStops(c,f,e,k&&"esriFieldTypeDate"===k.type))?b.length:0)f=10<f,this._drawGradientRamp(g,b,!f,a,this._getRampBorderColor(c),!!e,f)},_getMedianColor:function(a,b){var c,e;b.colors?
(c=b.minDataValue,e=b.maxDataValue):b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var g,d,v,m,q=!1;b.colors||b.opacityValues?(d=b.maxDataValue-b.minDataValue,g=f.map([0,.25,.5,.75,1],function(a){v=b.minDataValue+a*d;return Number(v.toFixed(6))}),this._checkPrecision(0,4,g)):b.stops&&(g=f.map(b.stops,function(a){return a.value}),(q=f.some(b.stops,function(a){return!!a.label}))&&(m=f.map(b.stops,function(a){return a.label})));
var k=g[0],l,h;d=g[g.length-1]-k;return f.map(g,function(f,p){c?(l=new A(c.toRgba()),h=a.getOpacity(f,{opacityInfo:b}),null!=h&&(l.a=h)):l=a.getColor(f,{colorInfo:b});var v="";if(q)v=m[p];else{var v=e?M.formatDate(f,M.timelineDateFormatOptions):E.format(f),B="";0===p?B=this._specialChars.lt+" ":p===g.length-1&&(B=this._specialChars.gt+" ");v=B+v}return{value:f,color:l,offset:1-(f-k)/d,label:v}},this).reverse()},_checkPrecision:function(a,b,c){var e=a+(b-a)/2,g=c[a],d=c[e],f=c[b],m=Math.floor(g),q=
Math.floor(d),k=Math.floor(f);m===g&&k===f&&q!==d&&m!==q&&k!==q&&(c[e]=q);a+1!==e&&this._checkPrecision(a,e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){var b;if("esri.renderer.SimpleRenderer"===a.declaredClass)b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,g,p,
v){var l=d.create("tr",{},a),q,k,h,n,r,t=b.length-1,u;n=0;this.alignRight?(a=d.create("td",{align:this._isRightToLeft?"left":"right"},l),q=d.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},l)):(q=d.create("td",{width:this.gradientWidth,align:"center"},l),a=d.create("td",{},l));l=g&&0<g.a&&!(240<=g.r&&240<=g.g&&240<=g.b);k=d.create("div",{"class":l?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},q);q=d.create("div",{"class":"esriLegendColorRamp"+
(p?" esriLegendTransparencyRamp":"")},k);p=y.get(q,"width");l&&(g=9>m("ie")?g.toHex():"rgba("+g.toRgba().join(",")+")",y.set(q,"border",this.colorRampBorder+" "+g));c?(g=this.gradientHeight*t,y.set(q,"height",g+"px")):g=y.get(q,"height");y.set(k,"height",g+"px");l=P.createSurface(q,p,g);9>m("ie")&&(n=l.getEventSource(),y.set(n,"position","relative"),y.set(n.parentNode,"position","relative"),n=1);try{c&&f.forEach(b,function(a,b){a.offset=b/t}),r=l.createRect({x:-n,y:-n,width:p+n,height:g+n}),r.setFill({type:"linear",
x1:0,y1:0,x2:0,y2:g,colors:b}).setStroke(null),l.createRect({width:p,height:g}).setFill(new A([255,255,255,1-e.opacity])).setStroke(null),this._surfaceItems.push(l)}catch(ra){l.clear(),l.destroy()}f.forEach(b,function(a,c){a.label&&(u="top:"+100*a.offset+"%;",a="",0===c&&(a+=" esriLegendColorRampTickFirst"),c===b.length-1&&(a+=" esriLegendColorRampTickLast"),d.create("div",{"class":"esriLegendColorRampTick"+a,innerHTML:"\x26nbsp;",style:u},k))});h=d.create("div",{"class":"esriLegendColorRampLabels",
style:{height:g+this.gradientHeight+"px"}},a);c?f.forEach(b,function(a){d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:C.encode(a.label)||"\x26nbsp;"},h)}):(d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:v?C.encode(b[0].label)||"\x26nbsp;":this._i18n.high},h),d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:v?C.encode(b[b.length-1].label)||"\x26nbsp;":this._i18n.low,style:"top: "+(g+this.gradientHeight-2*this.gradientHeight)+"px;"},h))},_showHeatRamp:function(a,
b,c,e,g){var f,l=c.field;f=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=d.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(f,a,b,g);(l=l&&this.getField(a,l,b))&&this._addSubHeader(e,this._getFieldAlias(l.name,a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,e,g,d;b&&b[0]?(c=b.length-1,(a=b[0]&&null!=b[0].ratio)?(a=b[c])&&1!==a.ratio&&
(b=b.slice(0),b.push({ratio:1,color:a.color}),c++):(e=b[0].value,g=b[c].value-e,b=f.map(b,function(a){return{color:a.color,ratio:(a.value-e)/g}}))):a&&a[0]&&(c=a.length-1,d=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*d}}));b=f.map(b,function(a,b){var e="";0===b?e="Low":b===c&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,e){var g=c.legendOptions,p,m,h,q,k,n,r,t=this.dotDensitySwatchSize,u=Math.round(t/2);g&&(m=
g.backgroundColor,h=g.outline,q=g.valueUnit,k=g.dotCoverage);k=(k||this.dotCoverage)/100;r=Math.round(t*t/Math.pow(c.dotSize,2)*k);e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);n=d.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(n,L.substitute({value:c.dotValue,unit:q||""},this.NLS_dotValue));f.forEach(c.fields,function(e){e=l.mixin({},e);e.numPoints=r;p=new ca(c._generateImageSrc(t,t,[e],{x:0,y:0},
{x:t,y:t},m),h||c.outline,t,t);e=this.getField(a,e.name,b)||e;this._buildRow_Renderer(a,p,null,C.encode(this._getFieldAlias(e.name,a,b)),null,n,{type:"path",path:"M "+-u+","+-u+" L "+u+","+-u+" L "+u+","+u+" L "+-u+","+u+" L "+-u+","+-u+" E"})},this)},_showSizeLegend:function(a,b,c,e,g,f,m,h,q){var k=e.legendOptions,k=k&&k.customValues;g=this._getSizeSymbol(c,g);if((!e.valueUnit||"unknown"===e.valueUnit)&&g&&(k||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&
!(1>=e.stops.length))){q=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(q?"":" esriLegendSubFragment")},f);f=d.create("tbody",{},q);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(q,a,b,h);(m||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,this._getRampTitle(e,a,b));m=(q=(h=e.field)&&!l.isFunction(h))&&"cluster_count"===h.toLowerCase();b=(b=q?a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(h):
this.getField(a,h,b):null)&&"esriFieldTypeDate"===b.type;var k=k||this._getDataValues(c,g,e,b,m),p,v=k.length-1;for(h=v;0<=h;h--)q=k[h],g=R.fromJson(g.toJson()),this._applySize(g,c,e,q),q=b?M.formatDate(q,M.timelineDateFormatOptions):E.format(q),p="",h===v?p=this._specialChars.gt+" ":0===h&&(p=m&&1===k[h]?"":this._specialChars.lt+" "),p="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+C.encode(p+q)+"\x3c/span\x3e",this._buildRow_Renderer(a,g,null,p,null,f)}},_getSizeSymbol:function(a,b){var c,e;
if("esri.renderer.SimpleRenderer"===a.declaredClass)c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)c=a.infos[0].symbol,e=1<a.infos.length;if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=R.fromJson(c.toJson()),b||e)-1!==c.type.indexOf("linesymbol")?c.setColor(new A(this.sizeRampDarkColor)):(c.setColor(new A(this.sizeRampLightColor)),
c.setOutline&&(a=new V,a.setColor(new A(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,e,g){if(g){var d;f.some([5,3,2],function(g){g=this._getDataValuesByCount(a,b,c,e,g);this._hasFractionalValues(g)||(d=g);return!!d},this);return d}return this._getDataValuesByCount(a,b,c,e,5)},_getDataValuesByCount:function(a,b,c,e,g,d){g=null==g?5:g;d=null==d?20:d;var l=a.getSizeRangeAtScale(c,this.map.getScale());g=this._interpolateSizeRange(l,g);var m=this._getDataRange(c),
h=f.map(g,function(a){return this._getDataValueFromSize(a,m,l)},this);if(!e){var k,h=E.round(h);for(e=1;e<h.length-1;e++)if(k=this._roundDataValue(a,b,c,h[e],h[e-1],d))h[e]=k[0],g[e]=k[1]}return h},_hasFractionalValues:function(a){return f.some(a,function(a){return a!==Math.floor(a)})},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var e,g=[];
for(e=0;e<b;e++)g.push(c+a*e);return g},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var g=b.min;b=b.max;return a<=e?g:a>=c?b:(a-e)/(c-e)*(b-g)+g},_roundDataValue:function(a,b,c,e,g,d){var f=this._getSize(b,a,c,e);g=this._getSize(b,a,c,g);var l,h=E.getDigits(e),k=h.integer,h=h.fractional,m,p,n,r,t,u,x,y,w,z,A;0<e&&1>e&&(l=Math.pow(10,h),e*=l,k=E.getDigits(e).integer);for(--k;0<=k&&(m=Math.pow(10,k),h=Math.floor(e/m)*m,m*=Math.ceil(e/m),null!=l&&(h/=l,m/=l),p=(h+m)/2,p=E.round([h,
p,m],{indexes:[1]})[1],n=this._getSize(b,a,c,h),r=this._getSize(b,a,c,m),t=this._getSize(b,a,c,p),u=E.getPctChange(f,n,g,null),x=E.getPctChange(f,r,g,null),y=E.getPctChange(f,t,g,null),w=u.prev<=d,z=x.prev<=d,w&&z&&(u.prev<=x.prev?(w=!0,z=!1):(z=!0,w=!1)),w?A=[h,n]:z?A=[m,r]:y.prev<=d&&(A=[p,t]),!A);k--);return A},_applySize:function(a,b,c,e){var g=a.type;b=this._getSize(a,b,c,e);switch(g){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":g=a.width;c=a.height;a.setHeight(b);
a.setWidth(g/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,e,g,f,h,m){var l=!!m,k=d.create("tr",{},f),p;if(this.alignRight){if(f=d.create("td",{align:this._isRightToLeft?"left":"right"},k),b||l)p=d.create("td",{align:this._isRightToLeft?"left":
"right",width:35},k)}else{if(b||l)p=d.create("td",{width:35,align:"center"},k);f=d.create("td",{},k)}var n=k=30,v;if(b)if("simplemarkersymbol"==b.type)k=Math.min(Math.max(k,b.size+12),125),n=Math.min(Math.max(n,b.size+12),125);else if("picturemarkersymbol"==b.type)k=Math.min(Math.max(k,b.width),125),n=Math.min(b.height||n,125);else if("textsymbol"==b.type){var r,t;b.text||(r=b.text,t=!0,b.setText(this.defaultText));k=Math.min(Math.max(k,b.getWidth()+12),125);n=Math.min(Math.max(n,b.getHeight()+12),
125);t&&b.setText(r)}if(b||l)v=d.create("div",{style:"width:"+k+"px;height:"+n+"px;"},p);L.isDefined(e)&&"number"===typeof e&&(e=""+e);d.create("td",{innerHTML:e||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},f))));if(b||l)a=this._drawSymbol(v,b,c,k,n,g,a,h,m),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=d.create("tr",{},a);a=d.create("td",{align:this._align,colspan:2},a);d.create("td",{innerHTML:C.encode(b)||"",align:this._align},d.create("tr",
{},d.create("tbody",{},d.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,e,g,d,f,h,n){var k=b&&R.fromJson(b.toJson()),p=f.opacity;b=!!n;if(k)if(c&&k.setColor(new A(c.toRgba())),"simplelinesymbol"===k.type||"cartographiclinesymbol"===k.type||"textsymbol"===k.type){if(!k.color)return;c=k.color.toRgba();c[3]*=p;k.color.setColor(c)}else"simplemarkersymbol"===k.type||"simplefillsymbol"===k.type?(k.color&&(c=k.color.toRgba(),c[3]*=p,k.color.setColor(c)),k.outline&&k.outline.color&&(c=k.outline.color.toRgba(),
c[3]*=p,k.outline.color.setColor(c))):"picturemarkersymbol"===k.type&&(a.style.opacity=p,a.style.filter="alpha(opacity\x3d("+100*p+"))");a=P.createSurface(a,e,g);9>m("ie")&&(c=a.getEventSource(),y.set(c,"position","relative"),y.set(c.parentNode,"position","relative"));d=b?n.shapeDescriptor:this._getDrawingToolShape(k,d)||R.getShapeDescriptors(k);var q,p=(c=d.defaultShape)&&"text"===c.type;try{p&&!c.text&&(c.text=this.defaultText),q=a.createShape(h||c).setFill(d.fill).setStroke(d.stroke),p&&q.setFont(d.font)}catch(qa){a.clear();
a.destroy();return}var v=q.getBoundingBox();h=v.width;d=v.height;var p=-(v.x+h/2),r=-(v.y+d/2);c=a.getDimensions();p={dx:p+c.width/2,dy:r+c.height/2};if(k&&"simplemarkersymbol"===k.type&&"path"===k.style)e=f._getScaleMatrix(v,k.size),q.applyTransform(K.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/2}));else if(h>e||d>g)f=h/e>d/g,e=((f?e:g)-5)/(f?h:d),l.mixin(p,{xx:e,yy:e});q.applyTransform(p);b&&q.applyTransform(K.rotategAt(n.rotation,h/2,d/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||
null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,
fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,e=b.numClasses,d=ga[e],f=!!c,h=Math.sqrt(Math.pow(75,2)+Math.pow(75,2)),m={};b.uvInfos.forEach(function(a){m[a.value]={label:a.label,fill:this._getSymbolColor(a.symbol)}},this);b=[];for(var l=0;l<e;l++){for(var k=[],n=0;n<e;n++)k.push(m[d[l][n]].fill);b.push(k)}d=this._getRelationshipCornerLabels(c,m);a=this._drawRampLayout(a,d,h,f);a=P.createSurface(a,h,h);f||(a.rawNode.style.margin="-15px -15px -18px -15px");
b=da.create2DColorRamp({surface:a,colors:b,numClasses:e,size:75});e=(h-75)/2;h=(h-75)/2;b.applyTransform(K.translate(e,h));f&&b.applyTransform(K.rotategAt(this._getRotationAngleForFocus(c),37.5,37.5));b=a.createGroup();d={width:1,color:"#555555"};l=a.defNode;this._createArrowMarker(l,"start");this._createArrowMarker(l,"end");l=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(d);d=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(d);this._setLineArrow(l.rawNode,"left",c);this._setLineArrow(d.rawNode,
"right",c);b.applyTransform(K.translate(e,h));f&&b.applyTransform(K.rotategAt(-45,37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,e){var g=d.create("div",{style:{padding:"10px"}},a);a=c+"px";c+="px";e?(e=d.create("div",{style:{display:"flex"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},e),g=d.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},e),d.create("div",
{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},e),e=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},g),e=d.create("div",{style:{height:c,width:c}},g),g=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},g)):(g=d.create("div",{style:{display:"table",color:"#555555"}},g),e=d.create("div",{style:{display:"table-row"}},g),c=d.create("div",
{style:{display:"table-row"}},g),g=d.create("div",{style:{display:"table-row"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},innerHTML:b.left},e),d.create("div",{style:{display:"table-cell"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},e),d.create("div",{style:{display:"table-cell"}},c),e=d.create("div",
{style:{display:"table-cell"}},c),d.create("div",{style:{display:"table-cell"}},c),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},innerHTML:b.bottom},g),d.create("div",{style:{display:"table-cell"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},g));return e},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===
a.type||"simplemarkersymbol"===a.type&&(a.style===Q.STYLE_X||a.style===Q.STYLE_CROSS)?(a=a.getStroke())&&a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=aa[a];a&&null==b&&(b=aa.HH);return b},_setLineArrow:function(a,b,c){var e=this.id+"_arrowStart",d=this.id+"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?d:e)+")");break;case "LL":a.setAttribute("marker-start","url(#"+d+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start",
"url(#"+(b?e:d)+")");break;default:a.setAttribute("marker-end","url(#"+e+")")}},_createArrowMarker:function(a,b){var c="start"===b,e=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var d=c?5:0,c=document.createElementNS("http://www.w3.org/2000/svg","marker");c.setAttribute("id",e);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",d);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");
e=document.createElementNS("http://www.w3.org/2000/svg","polyline");e.setAttribute("points",b);e.setAttribute("fill","none");e.setAttribute("stroke","#555555");e.setAttribute("stroke-width","1");c.appendChild(e);a.appendChild(c)},_getRelationshipCornerLabels:function(a,b){var c=b.HH.label,e=b.LL.label,d=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:e,left:d,right:b};case "HL":return{top:d,bottom:b,left:e,right:c};case "LL":return{top:e,bottom:c,left:b,right:d};case "LH":return{top:b,
bottom:d,left:c,right:e};default:return{top:c,bottom:e,left:d,right:b}}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&l.isArray(a.children)&&f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=C.encode(e),b.mouseMoveHandler=
b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=n.connect(a,"onmousemove",l.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,y.set(z.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(l.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,z.byId(this.id+"_hoverLabel")){var e=z.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";y.set(e,"top",
b+"px");y.set(e,"left",a+15+"px");y.set(e,"display","")}else d.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=n.connect(a,"onmouseout",l.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,y.set(z.byId(this.id+"_hoverLabel"),"display","none"))}))},
_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)n.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)n.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],c;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(e){c={id:e.id};c.source=e.source&&e.source.toJson();var d;a.layerDefinitions&&a.layerDefinitions[e.id]&&(d=a.layerDefinitions[e.id]);d&&(c.definitionExpression=
d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[e.id]&&(f=a.layerDrawingOptions[e.id]);f&&(c.drawingInfo=f.toJson());c.minScale=e.minScale||0;c.maxScale=e.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var e,d=b.dynamicLayerInfos||b.layerInfos;for(e=0;e<d.length;e++)if(c==d[e].id){-1<d[e].parentLayerId&&(y.set(z.byId(this.id+
"_"+a+"_"+d[e].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[e].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,l;for(h=0;h<e.length;h++)if(e[h].id===c&&e[h].subLayerIds)for(l=0;l<e[h].subLayerIds.length;l++){var m=e[h].subLayerIds[l];-1===f.indexOf(d,m)&&(d.push(m),b(m,d))}}a.layer.layerInfos&&f.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},
_isLayerInScale:function(a,b,c){var d,g=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var h,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==f.minScale&&a.tileInfo&&(h=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,l=Math.max(a.maxScale,f.maxScale));if(0<h&&h<c||l>c)g=
!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)g=!1;return g},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),
b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],L.isDefined(a)&&(b+=" ("+a+")"));return C.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(L.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;
var f;for(f=a.length-1;0<=f;f--)if(a[f].id==b)if(0==c&&0<a[f].minScale?c=a[f].minScale:0<c&&0==a[f].minScale||0<c&&0<a[f].minScale&&(c=Math.min(c,a[f].minScale)),d=Math.max(d||0,a[f].maxScale||0),-1<a[f].parentLayerId)b=a[f].parentLayerId;else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return!(!a||!("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.RasterXLayer"===a.declaredClass||
"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass))},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;
return!("esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!b.test(a.url))},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var d;f.forEach(c.fields,function(a){a.name===b&&(d=a)});return d}return null}});l.mixin(F,{ALIGN_LEFT:0,ALIGN_RIGHT:1});m("extend-esri")&&l.setObject("dijit.Legend",F,ba);return F});